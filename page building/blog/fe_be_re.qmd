---
title: "Understanding Panel Data Models in Health Economics"
author: "Heeyoung Lee"
date: "May 15, 2025"
format: 
  html:
    theme: cosmo
    css: custom.css
    code-fold: true
    code-tools: true
    toc: true
    toc-location: left
    self-contained: true
    fig-width: 10
    fig-height: 8
    fig-dpi: 300
    smooth-scroll: true
    highlight-style: github
---

## Understanding Panel Data Models

Panel data analysis represents one of the most powerful and versatile approaches in modern social science. By combining cross-sectional and time-series dimensions, panel data provides researchers with a multifaceted view of phenomena that would be impossible to obtain with either dimension alone. This document explores the theoretical foundations, practical applications, and interpretative nuances of the three primary panel data models: fixed effects, between effects, and random effects, with applications to county-level health research.

### Conceptual Framework for Panel Data Effects

Panel data contains observations across two dimensions: entities (cross-sectional) and time (temporal). In our health economics context, the entities are counties and the time periods are years. This dual structure offers several analytical advantages:

1. **Increased information and variability**: By tracking the same counties over time, we capture both between-county differences and within-county changes in health outcomes.

2. **Reduced collinearity**: The addition of the time dimension often helps mitigate multicollinearity problems common in cross-sectional health studies.

3. **Control for unobserved heterogeneity**: Perhaps most importantly, panel data allows us to control for unobserved county-specific characteristics that might otherwise bias our results, such as cultural attitudes toward health, historical healthcare infrastructure development, or geographic features.

4. **Dynamic relationships**: Panel data enables the study of dynamic relationships and the sequence of events, such as how changes in county income precede changes in mortality rates.

Let's begin by loading the necessary R packages for our analysis:

```{r library-imports, message=FALSE, warning=FALSE}
# Load all required packages 
library(plm)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(patchwork)
library(lmtest)     # For coeftest function
library(sandwich)   # For vcovHC function
library(fixest)     # For advanced fixed effects
library(texreg)     # For HTML regression tables
```

#### The General Panel Data Model

The fundamental challenge in panel data analysis lies in properly accounting for unobserved heterogeneity across counties. To understand this, we start with a general panel data model specification:

$$Mortality_{it} = \alpha + \beta Income_{it} + \gamma Z_{it} + u_i + \epsilon_{it}$$

Where:
- $Mortality_{it}$ is the mortality rate (per 100,000 population) for county $i$ in year $t$
- $\alpha$ is the global intercept (common to all counties)
- $Income_{it}$ represents the median household income (in thousands of dollars)
- $Z_{it}$ represents additional control variables (which may vary across both counties and time)
- $\beta$ and $\gamma$ represent the coefficients of interest (our primary estimation targets)
- $u_i$ is the county-specific effect (unobserved heterogeneity that is constant over time)
- $\epsilon_{it}$ is the idiosyncratic error term (varies across both counties and time)

The key question in panel data analysis is how to handle the county-specific effect $u_i$. Different approaches to this question lead to our three main panel data models: fixed effects, between effects, and random effects. Each model makes different assumptions about $u_i$ and extracts different types of information from the data.

Let's simulate some county health data to demonstrate these concepts:

```{r simulate-data}
# Create simulated county health data
set.seed(123)
n_counties <- 100
n_years <- 10
total_obs <- n_counties * n_years

# Generate county IDs and years
county_id <- rep(1:n_counties, each = n_years)
year <- rep(2013:2022, times = n_counties)

# Generate time-invariant county characteristics
# These will vary by county but remain constant over time
region <- rep(sample(c("Northeast", "Midwest", "South", "West"), 
                    n_counties, replace = TRUE, 
                    prob = c(0.2, 0.25, 0.35, 0.2)), 
             each = n_years)

rural_urban <- rep(sample(c("Rural", "Suburban", "Urban"), 
                         n_counties, replace = TRUE, 
                         prob = c(0.3, 0.4, 0.3)), 
                  each = n_years)

county_education <- rep(rnorm(n_counties, mean = 25, sd = 10), each = n_years)  # % with college degree
land_area <- rep(exp(rnorm(n_counties, mean = 5, sd = 1)), each = n_years)  # Square miles (log-normal)

# Generate county-specific effects (unobserved heterogeneity)
county_effect <- rep(rnorm(n_counties, mean = 0, sd = 50), each = n_years)

# Generate time-varying variables with both between and within variation
# Income (main X) - both county-specific component and time-varying component
income_county_component <- rep(rnorm(n_counties, mean = 60, sd = 15), each = n_years)  # County-specific mean
income_time_component <- rnorm(total_obs, mean = 0, sd = 5)  # Time variation within counties
income_trend <- rep(1:n_years, times = n_counties) * 0.5  # General upward trend over time
median_income <- income_county_component + income_time_component + income_trend

# Time-varying controls
uninsured_rate <- rep(runif(n_counties, 5, 25), each = n_years) + 
                  rnorm(total_obs, 0, 2) - 
                  rep(1:n_years, times = n_counties) * 0.3  # Declining trend over time

physician_density <- rep(rnorm(n_counties, mean = 250, sd = 100), each = n_years) + 
                     rnorm(total_obs, 0, 10)

hospital_beds <- rep(rnorm(n_counties, mean = 300, sd = 150), each = n_years) + 
                 rnorm(total_obs, 0, 15)

obesity_rate <- rep(rnorm(n_counties, mean = 30, sd = 5), each = n_years) + 
               rnorm(total_obs, 0, 1) + 
               rep(1:n_years, times = n_counties) * 0.1  # Slightly increasing trend

smoking_rate <- rep(rnorm(n_counties, mean = 18, sd = 6), each = n_years) + 
               rnorm(total_obs, 0, 1) - 
               rep(1:n_years, times = n_counties) * 0.2  # Declining trend

# Generate mortality rate (Y) with income effect (negative), controlling effects, and trends
income_effect <- -0.8  # Higher income reduces mortality rate
base_mortality <- 800  # Base mortality rate

mortality_rate <- base_mortality + 
                 income_effect * median_income +  # Main effect of interest
                 0.5 * uninsured_rate +  # Positive effect of uninsurance
                 -0.1 * physician_density +  # Negative effect of physician access
                 -0.05 * hospital_beds +  # Negative effect of hospital access
                 2 * obesity_rate +  # Positive effect of obesity
                 3 * smoking_rate +  # Positive effect of smoking
                 county_effect +  # County-specific unobserved factors
                 rnorm(total_obs, 0, 20)  # Random noise

# Create dataframe
county_health_df <- data.frame(
  county_id = county_id,
  year = year,
  region = region,
  rural_urban = rural_urban,
  county_education = county_education,
  land_area = land_area,
  median_income = median_income,
  uninsured_rate = uninsured_rate,
  physician_density = physician_density,
  hospital_beds = hospital_beds,
  obesity_rate = obesity_rate,
  smoking_rate = smoking_rate,
  mortality_rate = mortality_rate
)

# Create panel data object
county_panel <- pdata.frame(county_health_df, index = c("county_id", "year"))

# Display the first few rows of data
head(county_health_df, n = 20) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Fixed Effects Model: Within Variation in County Health

#### What Are Fixed Effects?

The fixed effects model treats the county-specific effect $u_i$ as a parameter to be estimated for each county. This approach is analogous to including a dummy variable for each county in our model, effectively giving each county its own intercept. By doing so, we control for all time-invariant characteristics of counties, whether these characteristics are observed or unobserved.

#### Intuition Behind Fixed Effects:

Fixed effects analysis answers a specific type of question: "How does a change in median household income **within** a county affect mortality rates?" This focus on within-county changes makes fixed effects particularly useful for causal inference when we suspect that unobserved county characteristics might correlate with our explanatory variables.

To understand the intuition more concretely:

- Fixed effects remove all between-county variation and focus only on within-county changes over time
- Each county serves as its own control, neutralizing the impact of stable characteristics
- This approach eliminates omitted variable bias from time-invariant factors, even if we can't measure them

Consider the effect of income on mortality rates across counties. Counties differ in many stable ways (geography, historical development, demographic composition) that might correlate with both income and mortality. Fixed effects would control for these county-specific characteristics by focusing only on how changes in a county's income relate to changes in that same county's mortality rates.

#### Mathematical Representation:

The fixed effects transformation mathematically subtracts the county-specific means from each observation:

$$Mortality_{it} - \overline{Mortality}_i = \beta(Income_{it} - \overline{Income}_i) + \gamma(Z_{it} - \overline{Z}_i) + (\epsilon_{it} - \overline{\epsilon}_i)$$

Where $\overline{Mortality}_i$, $\overline{Income}_i$, $\overline{Z}_i$, and $\overline{\epsilon}_i$ represent the means of $Mortality$, $Income$, $Z$, and $\epsilon$ for county $i$ across all time periods.

Notice that the county-specific effect $u_i$ disappears in this transformation, as $u_i - \overline{u}_i = 0$ for all counties (since $u_i$ is constant over time for each county). This "demeaning" process is what enables fixed effects to control for all time-invariant characteristics.

To visualize how fixed effects work in our health data, let's create a simulation that clearly demonstrates the concept:

```{r fe-detailed-viz, fig.width=10, fig.height=6}
# First, let's subset data to make visualization clearer
set.seed(42)
selected_counties <- sample(1:n_counties, 5)
selected_data <- county_health_df %>%
  filter(county_id %in% selected_counties)

# Create panel data object for selected counties
selected_panel <- pdata.frame(selected_data, index = c("county_id", "year"))

# Estimate fixed effects model
fe_model_viz <- plm(mortality_rate ~ median_income, data = selected_panel, model = "within")
fe_coef <- coef(fe_model_viz)[1]

# Add county means and calculate within deviations
selected_data <- selected_data %>%
  group_by(county_id) %>%
  mutate(
    mean_income = mean(median_income),
    mean_mortality = mean(mortality_rate),
    income_centered = median_income - mean_income,
    mortality_centered = mortality_rate - mean_mortality,
    # Calculate FE predictions with true county intercepts
    fe_intercept = mean_mortality - fe_coef * mean_income,
    fe_pred = fe_intercept + fe_coef * median_income
  ) %>%
  ungroup()

# Plot 1: Raw data with county-specific lines
p1 <- ggplot(selected_data, aes(x = median_income, y = mortality_rate, color = factor(county_id))) +
  geom_point(size = 3, alpha = 0.7) +
  geom_line(aes(y = fe_pred), linewidth = 1) +
  geom_hline(aes(yintercept = fe_intercept, color = factor(county_id)), 
             linetype = "dashed", show.legend = FALSE) +
  labs(title = "Fixed Effects Model for County Health Data",
       subtitle = paste0("All counties share the same slope \n (β = ", round(fe_coef, 2), 
                         ") but have different intercepts"),
       x = "Median Household Income ($1000s)", 
       y = "Mortality Rate (per 100,000)") +
  theme_minimal() +
  theme(legend.position = "right",
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 11)) +
  scale_color_discrete(name = "County ID")

# Plot 2: Centered data (demeaned within counties)
p2 <- ggplot(selected_data, aes(x = income_centered, y = mortality_centered, color = factor(county_id))) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, color = "black", linewidth = 1.2, formula = y ~ x) +
  labs(title = "Within-County Transformation",
       subtitle = "After subtracting county means (demeaning),\n the common slope reveals the effect of income changes",
       x = "Income - County Mean Income", 
       y = "Mortality - County Mean Mortality") +
  theme_minimal() +
  theme(legend.position = "right",
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 11)) +
  scale_color_discrete(name = "County ID")

# Combine plots
p1 + p2
```

#### Interpreting the Fixed Effects Visualization:

The visualization above illustrates two crucial aspects of fixed effects modeling with our health data:

1. **Left panel**: Shows the raw data with county-specific regression lines. Notice how:
   - Each county (color) has its own intercept (dashed horizontal line)
   - All counties share a common slope coefficient (the effect of income on mortality)
   - The lines are parallel, indicating the same relationship between income and mortality across counties, just shifted up or down by the county effect
   - Counties with higher baseline mortality rates have higher intercepts

2. **Right panel**: Shows the data after the "demeaning" transformation:
   - Each county's observations are centered around their own means (0,0)
   - The county-specific effects are removed
   - The common slope becomes apparent
   - All points now cluster around a single regression line showing how deviations in income from county averages relate to deviations in mortality from county averages

This transformation is the mathematical essence of fixed effects: by subtracting county means, we eliminate county-specific effects and isolate the within-county relationship between income and mortality.

#### Key Characteristics of Fixed Effects:

- **Advantages**:
  - Controls for all time-invariant omitted variables (observed and unobserved)
  - Reduces omitted variable bias from stable county characteristics (geography, culture, etc.)
  - No need to assume county effects are uncorrelated with regressors (a more restrictive assumption)
  - Provides strong causal evidence when properly applied, essential for health policy recommendations
  
- **Limitations**:
  - Cannot estimate the effect of time-invariant variables (region, rural/urban status)
  - Less efficient than random effects if its assumptions are met
  - Uses only within-county variation, potentially losing information about structural health disparities
  - May exacerbate measurement error issues through the demeaning process

Let's estimate a complete fixed effects model with our health controls:

```{r fe-model-full}
# Estimate full fixed effects model
fe_health <- plm(mortality_rate ~ median_income + uninsured_rate + physician_density + 
                hospital_beds + obesity_rate + smoking_rate,
               data = county_panel, model = "within")

# Display results
summary(fe_health)
```

The fixed effects estimates show how changes in county income and health factors affect mortality rates over time, controlling for all time-invariant county characteristics.

### Between Effects Model: Cross-Sectional Variation

#### What Are Between Effects?

The between effects model takes a completely different approach. Instead of focusing on within-county variation, it averages observations for each county over time and estimates a regression using only these county averages. This approach focuses exclusively on differences between counties, treating time variation within counties as noise to be averaged out.

#### Intuition Behind Between Effects:

Between effects answer a fundamentally different question than fixed effects: "How do differences in average income **between** counties relate to differences in their average mortality rates?" This cross-sectional focus makes between effects useful for understanding long-run equilibrium relationships and structural health disparities across counties.

To understand the intuition:

- Between effects examine only cross-sectional relationships using county averages
- Time variation within counties is treated as noise and averaged out
- This approach reveals stable, long-term relationships between counties and persistent health disparities

In our health data example, between effects would examine how differences in average median income across counties relate to differences in their average mortality rates. This approach focuses on comparing different counties rather than tracking changes within each county over time.

#### Mathematical Representation:

The between effects model can be expressed as:

$$\overline{Mortality}_i = \alpha + \beta \overline{Income}_i + \gamma \overline{Z}_i + u_i + \overline{\epsilon}_i$$

Where $\overline{Mortality}_i$, $\overline{Income}_i$, and $\overline{Z}_i$ are the averages of $Mortality$, $Income$, and $Z$ for county $i$ across all time periods.

Let's visualize the between effects approach using our simulated health data:

```{r be-detailed-viz, fig.width=10, fig.height=6}
# Calculate county averages for between effects
county_means <- selected_data %>%
  group_by(county_id) %>%
  summarize(
    mean_income = mean(median_income),
    mean_mortality = mean(mortality_rate),
    region = first(region),
    rural_urban = first(rural_urban)
  )

# Fit between effects model for visualization
be_model_viz <- lm(mean_mortality ~ mean_income, data = county_means)
be_coef <- coef(be_model_viz)[2]
be_intercept <- coef(be_model_viz)[1]

# Add predictions
county_means$be_pred <- predict(be_model_viz)

# Plot 1: Raw data with county means highlighted
p3 <- ggplot() +
  # Add individual observations with reduced opacity
  geom_point(data = selected_data, aes(x = median_income, y = mortality_rate, color = factor(county_id)), alpha = 0.3) +
  # Add county means as larger points
  geom_point(data = county_means, aes(x = mean_income, y = mean_mortality, color = factor(county_id)), size = 5) +
  # Add between effects regression line
  geom_abline(intercept = be_intercept, slope = be_coef, color = "black", 
              linewidth = 1.2) +
  labs(title = "Between Effects Model for County Health",
       subtitle = "Focuses on differences between county averages,\n ignoring within-county variation over time",
       x = "Median Household Income ($1000s)", 
       y = "Mortality Rate (per 100,000)") +
  theme_minimal() +
  theme(legend.position = "right",
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 11)) +
  scale_color_discrete(name = "County ID")

# Plot 2: Between-only visualization with county means
p4 <- ggplot(county_means, aes(x = mean_income, y = mean_mortality, color = factor(county_id))) +
  geom_point(size = 5) +
  geom_smooth(method = "lm", se = TRUE, color = "black", formula = y ~ x) +
  geom_text(aes(label = county_id), vjust = -1, fontface = "bold") +
  labs(title = "Between Effects: County Averages Only",
       subtitle = paste0("Estimated slope (β = ", round(be_coef, 2), 
                       ")\n reflects cross-sectional health disparities"),
       x = "County Mean Income ($1000s)", 
       y = "County Mean Mortality Rate") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 11))

# Combine plots
p3 + p4
```

#### Interpreting the Between Effects Visualization:

The visualization above illustrates the between effects approach with our health data:

1. **Left panel**: Shows the raw data with county means highlighted as larger points:
   - Individual observations (small points) show the full dataset with year-to-year fluctuations
   - County means (large points) represent the average income and mortality for each county
   - The black regression line is fitted using only these county means
   - Within-county variation around each mean is ignored, treating temporal changes as noise

2. **Right panel**: Shows only the county means:
   - Each point represents the average for one county over the entire period
   - The regression line shows the cross-sectional relationship between income and mortality
   - The confidence interval (gray area) reflects uncertainty about this relationship
   - Labels identify each county
   - This plot illustrates structural health disparities between counties

Notice how the between effects slope (negative relationship between income and mortality) may differ from the fixed effects slope. This difference highlights how the two approaches extract different information from the same health dataset.

Let's estimate a complete between effects model with our health controls:

```{r be-model-full}
# Estimate full between effects model
be_health <- plm(mortality_rate ~ median_income + uninsured_rate + physician_density + 
                hospital_beds + obesity_rate + smoking_rate,
               data = county_panel, model = "between")

# Display results
summary(be_health)
```

The between effects estimates show how differences in average income and health factors across counties relate to differences in their average mortality rates, focusing on structural cross-sectional health disparities.

#### Key Characteristics of Between Effects:

- **Advantages**:
  - Can estimate the effect of time-invariant variables (unlike fixed effects)
  - Focuses on long-run equilibrium relationships between counties
  - Reveals structural health disparities
  - Simplifies interpretation for cross-sectional health comparisons
  
- **Limitations**:
  - Highly susceptible to omitted variable bias from unobserved county characteristics
  - Doesn't control for unobserved county heterogeneity
  - Loses all information about within-county dynamics and temporal changes
  - Small sample size (only one observation per county) reduces statistical power

### Random Effects Model: Weighted Combination

#### What Are Random Effects?

The random effects model takes a middle-ground approach that combines elements of both fixed and between effects. Instead of treating county-specific effects as fixed parameters to be estimated (as in fixed effects) or ignoring within-county variation (as in between effects), random effects treats $u_i$ as a random variable drawn from a specified distribution, typically assumed to be normally distributed with mean zero.

#### Intuition Behind Random Effects:

Random effects answer yet a third type of question: "What is the effect of income on mortality rates, considering both within-county and between-county variation?" This balanced approach makes random effects potentially more efficient and informative when its assumptions are met.

To understand the intuition:

- Random effects use a weighted combination of within and between variation
- The weights depend on the relative variances of the county-specific and idiosyncratic error terms
- Random effects "shrink" county-specific estimates toward the global mean (partial pooling)
- This approach can be viewed as a compromise between complete pooling (ignoring county differences) and no pooling (treating each county separately)

In our health example, random effects would use both the variation in income within each county over time and the variation between different counties to estimate the relationship between income and mortality rates. This combines information from both sources.

#### Mathematical Representation:

The random effects model is expressed as:

$$Mortality_{it} = \alpha + \beta Income_{it} + \gamma Z_{it} + u_i + \epsilon_{it}$$

Where $u_i \sim N(0, \sigma_u^2)$ is assumed to be random and uncorrelated with $Income_{it}$ and $Z_{it}$.

The random effects estimator is effectively a matrix-weighted average of the fixed effects and between effects estimators:

$$\hat{\beta}_{RE} = \hat{\beta}_{FE} \times W + \hat{\beta}_{BE} \times (I - W)$$

Where $W$ is a weight matrix that depends on the variance components $\sigma_u^2$ and $\sigma_\epsilon^2$.

Let's visualize the random effects approach using our simulated health data:

```{r re-detailed-viz, fig.width=10, fig.height=6}
# Estimate random effects model
re_model_viz <- plm(mortality_rate ~ median_income, data = selected_panel, model = "random")
re_coef <- coef(re_model_viz)[2]  # Index 2 because intercept is at index 1
re_intercept <- coef(re_model_viz)[1]

# Extract county-specific random effects
re_effects <- as.numeric(ranef(re_model_viz))

# Add to county means dataframe
county_means$re_effect <- re_effects
county_means$re_intercept <- re_intercept + re_effects

# Add RE predictions to selected dataframe
selected_data <- selected_data %>%
  left_join(county_means %>% select(county_id, re_intercept), by = "county_id") %>%
  mutate(re_pred = re_intercept + re_coef * median_income)

# Choose one county for clear visualization (county id 74)
selected_counties[4]
county_1 <- selected_data %>% filter(county_id == selected_counties[4])
county_1_mean <- county_means %>% filter(county_id == selected_counties[4])

# Calculate combined predictions for county id 74
county_1$fe_pred_full <- county_1$fe_intercept + fe_coef * county_1$median_income
county_1$be_pred_full <- be_intercept + be_coef * county_1$median_income
county_1$re_pred_full <- county_1$re_intercept + re_coef * county_1$median_income

# Plot 1: Random Effects as weighted average (for county id 74)
p5 <- ggplot(county_1, aes(x = median_income, y = mortality_rate)) +
  geom_point(size = 3, color = "purple") +
  geom_line(aes(y = fe_pred_full, color = "Fixed Effects"), linewidth = 1.2) +
  geom_line(aes(y = be_pred_full, color = "Between Effects"), linewidth = 1.2) +
  geom_line(aes(y = re_pred_full, color = "Random Effects"), linewidth = 1.5, linetype = "dashed") +
  geom_vline(xintercept = county_1_mean$mean_income, linetype = "dotted", color = "gray40") +
  geom_hline(yintercept = county_1_mean$mean_mortality, linetype = "dotted", color = "gray40") +
  geom_point(data = county_1_mean, aes(x = mean_income, y = mean_mortality), size = 5, shape = 23, fill = "yellow") +
  scale_color_manual(values = c("Fixed Effects" = "blue", 
                               "Between Effects" = "red",
                               "Random Effects" = "purple")) +
  labs(title = "Random Effects as Weighted Average\n(County ID = 74)",
       subtitle = "Random effects balance between fixed and between effects\nfor optimal use of health data",
       x = "Median Household Income ($1000s)", 
       y = "Mortality Rate (per 100,000)",
       color = "Model") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 11))

# Plot 2: All counties with random effects lines
p6 <- ggplot(selected_data, aes(x = median_income, y = mortality_rate, color = factor(county_id))) +
  geom_point(alpha = 0.7) +
  geom_line(aes(y = re_pred), linewidth = 1) +
  labs(title = "Random Effects Model for County Health",
       subtitle = paste0("Partial pooling: county intercepts are 'shrunk' toward global mean"),
       x = "Median Household Income ($1000s)", 
       y = "Mortality Rate (per 100,000)") +
  theme_minimal() +
  theme(legend.position = "right",
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 11)) +
  scale_color_discrete(name = "County ID")

# Combine plots
p5 + p6
```

Let's estimate a complete random effects model with our health controls:

```{r re-model-full}
# Estimate full random effects model
re_health <- plm(mortality_rate ~ median_income + uninsured_rate + physician_density + 
                hospital_beds + obesity_rate + smoking_rate,
               data = county_panel, model = "random")

# Display results
summary(re_health)
```

#### Interpreting the Random Effects Visualization:

The visualization above provides crucial insights into how random effects work with our health data:

1. **Left panel**: Shows how random effects act as a weighted average for County 1:
   - The blue line (Fixed Effects) shows County 1's fitted line using only within-county variation
   - The red line (Between Effects) shows the prediction based on cross-county variation 
   - The purple dashed line (Random Effects) represents the compromise between these approaches
   - Notice how the random effects line falls between the fixed and between effects lines
   - The yellow diamond marks County 1's mean values, which anchor the between effects estimate

2. **Right panel**: Shows all counties with their random effects fitted lines:
   - Each county has its own intercept, but these are "shrunk" toward the global mean
   - The amount of shrinkage depends on:
     - The relative variation within vs. between counties
     - The reliability of each county's individual estimate
   - Counties with more observations or less internal variation get less shrinkage

This "partial pooling" approach is what makes random effects a middle ground between fixed effects (separate intercepts for each county) and pooled OLS (one common intercept for all counties).

#### The Mathematics of Shrinkage in Random Effects:

The degree of shrinkage in random effects depends on the variance components. If we define the "reliability" of county means as:

$\theta = \frac{\sigma_u^2}{\sigma_u^2 + \sigma_\epsilon^2/T_i}$

Where $T_i$ is the number of observations for county $i$, then the random effects estimator for the county-specific effect $u_i$ is:

$\hat{u}_i^{RE} = \theta \times \hat{u}_i^{FE}$

When the between-county variance $\sigma_u^2$ is large relative to the within-county variance $\sigma_\epsilon^2$, or when $T_i$ is large, $\theta$ approaches 1, and the random effects estimator approaches the fixed effects estimator. Conversely, when $\sigma_u^2$ is small or $T_i$ is small, $\theta$ approaches 0, and the estimator shrinks toward the global mean.

In our health context, this means counties with health metrics that vary greatly from the national average but have consistent measurements over time will have estimates closer to their own fixed effects. Counties with measurements close to national averages or with inconsistent data will be pulled toward the population average.

#### Key Characteristics of Random Effects:

- **Advantages**:
  - More efficient than fixed effects when assumptions are met
  - Can estimate time-invariant variables (rural/urban status, region) unlike fixed effects
  - Uses both within and between variation (more information about health disparities)
  - Often produces smaller standard errors than fixed effects, which can be valuable for health policy research
  
- **Limitations**:
  - Assumes county effects are uncorrelated with regressors (strict exogeneity)
  - This assumption is often violated in health economics (e.g., unobserved health infrastructure may correlate with income)
  - Can lead to inconsistent estimates if the assumption is violated
  - More complex interpretation than fixed or between effects

#### Intraclass Correlation Coefficient (ICC): Understanding Between vs. Within Variation

A crucial but often overlooked aspect of panel data analysis in health economics is quantifying how much variation exists between counties versus within counties over time. The Intraclass Correlation Coefficient (ICC) provides precisely this information, making it an essential diagnostic tool when working with county health data.

##### What is ICC?

The ICC measures the proportion of total variance in mortality rates that is due to differences between counties (between-county variance). Mathematically:

$ICC = \frac{\sigma^2_{\text{between}}}{\sigma^2_{\text{between}} + \sigma^2_{\text{within}}}$

Where:
- $\sigma^2_{\text{between}}$ is the variance between counties
- $\sigma^2_{\text{within}}$ is the variance within counties over time

The ICC ranges from 0 to 1:
- ICC ≈ 0: Almost all variation in mortality occurs within counties over time
- ICC ≈ 1: Almost all variation in mortality occurs between counties (stable county differences)

##### Why ICC Matters?

The ICC has several important implications for research using random effects models:

1. **Weighting Mechanism**: The ICC directly influences how random effects models weight between and within variation. With a high ICC, random effects estimates will be closer to between effects estimates; with a low ICC, they'll be closer to fixed effects estimates.

2. **Model Selection**: Higher ICC values suggest that between-county differences are substantial, which may inform whether fixed effects, random effects, or between effects models are most appropriate for health policy questions.

3. **Effect of Fixed Effects**: The ICC indicates how much variation is "removed" when applying fixed effects. A high ICC means fixed effects controls for a large portion of the total variation in mortality.

4. **Design Efficiency**: For research design, the ICC helps determine whether to sample more counties or more time periods per county in future health studies.

Let's calculate and visualize the ICC using our simulated health data:

```{r icc-calculation}
# Calculate variance components and ICC
re_model_components <- plm(mortality_rate ~ median_income, data = county_panel, model = "random")
variance_components <- ercomp(re_model_components)

# Extract the variance components
sigma2_between <- variance_components$sigma2[1]  # Between variance
sigma2_within <- variance_components$sigma2[2]   # Within variance
total_variance <- sigma2_between + sigma2_within
icc <- sigma2_between / total_variance

# Create a dataframe for the variance components
variance_df <- data.frame(
  Component = c("Between-County Variance", "Within-County Variance", "Total Variance"),
  Value = c(sigma2_between, sigma2_within, total_variance),
  Percentage = c(sigma2_between/total_variance, sigma2_within/total_variance, 1) * 100
)

# Display the variance components
kable(variance_df, caption = "Variance Components and ICC in Mortality Rates") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(3, background = ifelse(variance_df$Component == "Between-County Variance", 
                                    "#e6f7ff", "#ffffff"))
```

```{r icc-visualization, fig.width=10, fig.height=8}
# Visualize the ICC

# Create a dataset for visualization
panel_long <- selected_data %>%
  select(county_id, year, mortality_rate) %>%
  mutate(county_numeric = as.numeric(factor(county_id)))

# Calculate global and county-specific means
global_mean <- mean(panel_long$mortality_rate)
county_means_viz <- panel_long %>%
  group_by(county_id) %>%
  summarize(county_mean = mean(mortality_rate))

# Join means back to data
panel_long <- panel_long %>%
  left_join(county_means_viz, by = "county_id") %>%
  mutate(
    # Deviations from means
    dev_global = mortality_rate - global_mean,
    dev_county = mortality_rate - county_mean,
    
    # For visualization positioning
    county_numeric = as.numeric(factor(county_id)),
    county_pos = county_numeric + 0.1 * (as.numeric(factor(year)) - mean(as.numeric(factor(unique(year)))))
  )

# Create an ICC visualization
p_icc <- ggplot() +
  # Add a reference line for global mean
  geom_hline(yintercept = global_mean, color = "black", linetype = "dashed", linewidth = 1) +
  
  # Add county means as horizontal lines
  geom_segment(data = county_means_viz, 
              aes(x = as.numeric(factor(county_id)) - 0.4, 
                  xend = as.numeric(factor(county_id)) + 0.4,
                  y = county_mean, yend = county_mean, color = factor(county_id)),
              linewidth = 1.5) +
  
  # Add points for individual observations
  geom_point(data = panel_long, 
             aes(x = county_pos, y = mortality_rate, color = factor(county_id)),
             size = 3, alpha = 0.7) +
  
  # Connect points to county means with thin lines to show within variation
  geom_segment(data = panel_long,
              aes(x = county_pos, xend = county_pos, 
                  y = county_mean, yend = mortality_rate, color = factor(county_id)),
              alpha = 0.4, linewidth = 0.5) +
  
  # Annotations
  annotate("text", x = 5.5, y = global_mean + 20, 
           label = "Global Mean Mortality", fontface = "bold") +
  annotate("text", x = 5.5, y = global_mean - 20, 
           label = paste0("ICC = ", round(icc, 2)), fontface = "bold") +
  
  # Customize the plot
  labs(title = "Understanding ICC in County Health Panel Data",
       subtitle = paste0("Between-County Variance: ", round(sigma2_between, 1), 
                         " (", round(100*icc, 1), "% of total)\n",
                         "Within-County Variance: ", round(sigma2_within, 1),
                         " (", round(100*(1-icc), 1), "% of total)"),
       x = "County", 
       y = "Mortality Rate (per 100,000)") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", size = 16),
        plot.subtitle = element_text(size = 12),
        axis.text.x = element_text(face = "bold"),
        panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = 1:5, labels = selected_counties) +
  scale_color_discrete(name = "County ID") +
  coord_cartesian(xlim = c(0.5, 5.5))

# Create a second plot demonstrating how ICC affects random effects weighting
weight_theta <- sigma2_between / (sigma2_between + sigma2_within/10)  # 10 is our n_years

# Create a sequence of ICC values for demonstration
icc_seq <- seq(0, 1, by = 0.01)
weight_seq <- icc_seq / (icc_seq + (1-icc_seq)/10)

# Create a dataframe for the weight demonstration
weight_df <- data.frame(
  ICC = icc_seq,
  RE_Weight = weight_seq
)

# Mark our current ICC on the plot
current_weight <- data.frame(
  ICC = icc,
  RE_Weight = weight_theta
)

# Create weight visualization
p_weight <- ggplot(weight_df, aes(x = ICC, y = RE_Weight)) +
  geom_line(color = "purple", linewidth = 1.2) +
  geom_point(data = current_weight, size = 4, color = "red") +
  geom_text(data = current_weight, 
            aes(label = paste0("Our health data: ICC = ", round(ICC, 2), 
                              "\nRE Weight = ", round(RE_Weight, 2))),
            hjust = -0.1, vjust = 0.5, fontface = "bold") +
  geom_hline(yintercept = c(0, 1), linetype = "dotted", color = "gray50") +
  geom_vline(xintercept = c(0, 1), linetype = "dotted", color = "gray50") +
  labs(title = "How ICC Affects Random Effects Weights in Health Research",
       subtitle = "Higher ICC values give more weight to between-county variation in mortality",
       x = "Intraclass Correlation Coefficient (ICC)", 
       y = "Weight Given to Between-County Variation") +
  scale_x_continuous(labels = scales::percent_format()) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 16),
        plot.subtitle = element_text(size = 12))

# Combine the plots using patchwork
p_icc / p_weight
```

##### Interpreting the ICC Visualization

The visualization illustrates several key aspects of the ICC:

1. **Top panel**: Shows how the total variation in mortality rates can be decomposed:
   - The dashed black line represents the global mean mortality rate
   - The colored horizontal lines show county-specific mean mortality rates
   - The vertical colored lines represent within-county variation over time
   - The spread of county means around the global mean represents between-county variation in mortality
   - Our ICC shows what percentage of the total variation is due to differences between counties

2. **Bottom panel**: Demonstrates how the ICC affects the weighting in random effects models:
   - The curve shows how random effects weights between-county variation based on the ICC
   - With ICC = 0, random effects gives no weight to between variation (equivalent to fixed effects)
   - With ICC = 1, random effects gives full weight to between variation (equivalent to between effects)
   - The red dot shows our health data's position, indicating why our random effects estimates might be closer to one approach than the other

##### ICC and Health Policy Implications

The ICC in health data has important policy implications:

1. High ICC values (>0.7) indicate that most health disparities are structural and persistent between counties, suggesting policy interventions should focus on addressing fundamental county differences.

2. Low ICC values (<0.3) indicate that health outcomes vary more over time within counties than between them, suggesting that temporal factors (policy changes, economic fluctuations) have stronger effects than structural county differences.

3. Moderate ICC values suggest both structural differences and temporal effects matter for health outcomes.

### Model Selection: When to Use Each Approach in Health Economics

Choosing the appropriate panel data model depends on both statistical considerations and the health policy research question at hand. The following table summarizes the key differences between the three approaches in the context of health economics:

```{r model-comparison-table}
# Extract coefficients from all models for income
fe_income_coef <- round(coef(fe_health)[1], 3)
be_income_coef <- round(coef(be_health)[1], 3)
re_income_coef <- round(coef(re_health)[2], 3)  # Index 2 because of constant term

# Create a comparison table of all models with enhanced insights
comparison_df <- data.frame(
  Feature = c(
    "Focus", 
    "Handles unobserved county heterogeneity", 
    "Can estimate time-invariant variables (region, rural/urban)",
    "Efficiency",
    "Consistency when county effects correlated with income",
    "Key assumption",
    "Appropriate health research question",
    "Income coefficient in our example"
  ),
  
  `Fixed Effects` = c(
    "Within-county variation (changes over time)", 
    "Yes - controls for all time-invariant county effects",
    "No",
    "Lower",
    "Yes",
    "No assumptions about correlation between county effects and regressors",
    "How do changes in county income affect mortality rates over time?",
    paste0("β = ", fe_income_coef)
  ),
  
  `Between Effects` = c(
    "Between-county variation (cross-sectional differences)",
    "No",
    "Yes",
    "Depends on between variation",
    "No",
    "Between variation is not contaminated by omitted variables",
    "How do structural differences in county income relate to mortality disparities?",
    paste0("β = ", be_income_coef)
  ),
  
  `Random Effects` = c(
    "Weighted combination of within and between variation",
    "Partially",
    "Yes",
    "Higher (if assumptions met)",
    "No",
    "County effects uncorrelated with regressors",
    "What is the overall relationship between income and mortality using all available information?",
    paste0("β = ", re_income_coef)
  )
)

# Display the table with kable for nice formatting
kable(comparison_df, caption = "Comparison of Panel Data Models in Health Economics") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = TRUE) %>%
  row_spec(0, bold = TRUE, background = "#f2f2f2")
```

### Hausman Test: Choosing Between Fixed and Random Effects

While theoretical considerations should guide your model choice, statistical tests can help inform the decision between fixed and random effects. The most common test for this purpose is the Hausman test, which compares the fixed effects and random effects models to determine if the key random effects assumption (that county effects are uncorrelated with regressors) holds.

```{r enhanced-hausman}
# Perform Hausman test with better explanation
hausman_test <- phtest(fe_health, re_health)

# Extract test statistics
hausman_stat <- round(hausman_test$statistic, 3)
hausman_pval <- round(hausman_test$p.value, 4)
hausman_df <- hausman_test$parameter

# Create dataframe for nice output
hausman_df <- data.frame(
  Metric = c("Chi-squared statistic", "Degrees of freedom", "p-value", "Decision at α = 0.05"),
  Value = c(
    hausman_stat,
    hausman_df,
    hausman_pval,
    ifelse(hausman_pval < 0.05, "Reject H₀: Use Fixed Effects", "Fail to reject H₀: Random Effects OK")
  )
)

# Display the Hausman test results
kable(hausman_df, caption = "Hausman Test Results for Health Data") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  column_spec(1, bold = TRUE)
```

#### Intuition Behind the Hausman Test:

The Hausman test compares the coefficient estimates from fixed effects and random effects models. The logic is as follows:

- **Null hypothesis** (H₀): Random effects assumptions are valid (county effects uncorrelated with regressors)
- **Alternative hypothesis** (H₁): Fixed effects should be used (correlation present)
- Under H₀, both estimators are consistent, but random effects is more efficient
- Under H₁, only fixed effects remains consistent
- If the difference between the two sets of estimates is statistically significant, we reject H₀ and conclude that fixed effects is the appropriate model

In our health economics context, the test essentially asks: "Are unobserved county characteristics (like healthcare infrastructure, cultural health attitudes) correlated with included variables like income and health behaviors?" If they are, fixed effects is preferred.

#### Limitations of the Hausman Test:

While the Hausman test is widely used, it's important to note its limitations in health economics applications:

1. It only tests one assumption of random effects (no correlation between county effects and regressors)
2. It can be sensitive to violations of other assumptions (e.g., homoskedasticity in health variables)
3. With large numbers of counties and few time periods, the test may have high power, detecting even minor violations
4. The test doesn't consider the substantive significance of any differences for health policy

For these reasons, the Hausman test should be considered one piece of evidence in your model selection process, not the sole determining factor for health policy research.

### Beyond the Basic Models: Extensions and Advanced Considerations

While fixed, between, and random effects form the foundation of panel data analysis in health economics, several extensions and considerations can further enhance your modeling approach:

#### 1. Robust Standard Errors

Health panel data often exhibits complex error structures, including:
- Serial correlation (correlation over time within counties)
- Cross-sectional dependence (correlation across counties, especially neighboring ones)
- Heteroskedasticity (unequal error variances)

To address these issues, it's common to use clustered or robust standard errors:

```{r robust-se-example}
# Fixed effects with clustered standard errors (county level)
fe_health_robust <- plm(mortality_rate ~ median_income + uninsured_rate + physician_density + 
                       hospital_beds + obesity_rate + smoking_rate,
                      data = county_panel, model = "within")
coeftest(fe_health_robust, vcov = vcovHC(fe_health_robust, type = "HC1", cluster = "group"))
```

The clustered standard errors account for the fact that observations within the same county are likely correlated over time, providing more appropriate inference for health policy decisions.

#### 2. Time Fixed Effects

In addition to county fixed effects, you may want to include time fixed effects to control for temporal shocks common to all counties, such as national health policy changes, economic recessions, or pandemic years:

```{r time-fe-example}
# Two-way fixed effects model for health data
fe_two_way <- plm(mortality_rate ~ median_income + uninsured_rate + physician_density + 
                 hospital_beds + obesity_rate + smoking_rate,
                data = county_panel, model = "within", effect = "twoways")
summary(fe_two_way)
```

Two-way fixed effects models control for both county-specific heterogeneity and time-specific effects that affect all counties simultaneously. This approach is particularly valuable when studying health phenomena that might be influenced by common temporal shocks, such as:
- National health policy reforms (e.g., Affordable Care Act implementation)
- Economic recessions affecting healthcare access
- Disease outbreaks or pandemics
- Major changes in medical technologies or treatments

#### 3. Dynamic Panel Models

Static panel models assume that current values of mortality depend only on current values of income and other factors. However, many health relationships involve dynamic processes where past health outcomes influence current ones. Dynamic panel models incorporate lagged dependent variables:

```{r dynamic-example-setup}
# Creating a lagged mortality variable for demonstration
county_health_df <- county_health_df %>%
  arrange(county_id, year) %>%
  group_by(county_id) %>%
  mutate(lag_mortality = lag(mortality_rate, 1)) %>%
  ungroup()

# Remove first year observations which have NA for lagged values
county_health_dyn <- county_health_df %>%
  filter(!is.na(lag_mortality))

# Create panel data object
county_panel_dyn <- pdata.frame(county_health_dyn, index = c("county_id", "year"))

# Simple dynamic model
dynamic_model <- plm(mortality_rate ~ lag_mortality + median_income + uninsured_rate,
                    data = county_panel_dyn, model = "within")
summary(dynamic_model)
```

Dynamic models are particularly relevant for health outcomes which often exhibit strong path dependence:
- Health infrastructure develops gradually and influences future outcomes
- Population health status has momentum and doesn't change rapidly
- Health behaviors tend to be persistent
- Intergenerational health patterns may be reflected in county-level data

#### 4. Heterogeneous Income Effects Across Counties

Standard panel models assume homogeneous slopes across counties - that the relationship between income and mortality is the same for all counties. This assumption can be relaxed to examine how income effects vary by county characteristics:

```{r heterogeneous-effects}
# Interaction model examining if income effects differ by rural/urban status
re_interaction <- plm(mortality_rate ~ median_income*rural_urban + uninsured_rate + 
                     physician_density + hospital_beds + obesity_rate + smoking_rate,
                    data = county_panel, model = "random")
summary(re_interaction)
```

Heterogeneous effects models are particularly useful in health policy research when:
- Income-health relationships may differ between rural and urban areas
- Effects of healthcare access might vary by region
- Health behavior impacts might depend on county education levels
- Policy effectiveness might vary by county characteristics

### Conclusion: Key Takeaways and Best Practices for Health Economics Research

Panel data analysis provides health economists and policymakers with powerful tools to address complex causal questions by leveraging both cross-sectional and temporal variation. The three core models - fixed effects, between effects, and random effects - each extract different information from health data and answer fundamentally different questions:

1. **Fixed Effects** focus on within-county changes over time, effectively controlling for all time-invariant characteristics of counties. This approach is particularly valuable for causal inference when unobserved county characteristics might correlate with explanatory variables. The key question answered is "How does a change in income within a county affect mortality rates?"

2. **Between Effects** focus exclusively on cross-sectional relationships between counties, averaging out temporal variation. This approach reveals long-run structural health disparities but doesn't address potential omitted variable bias from unobserved county characteristics. The key question answered is "How do differences in average income between counties relate to differences in their average mortality rates?"

3. **Random Effects** provide a middle ground, using both within and between variation through a weighted average approach. This method is more efficient when its key assumption holds: that county-specific effects are uncorrelated with the regressors. The key question answered is "What is the effect of income on mortality rates, considering both within-county and between-county information?"

#### Best Practices for Applied Health Economics Researchers:

1. **Let your health policy research question guide model selection** - Different models answer different questions about health determinants

2. **Conduct thorough diagnostics** - Test for heteroskedasticity, serial correlation, cross-sectional dependence, and model assumptions in health data

3. **Use robust standard errors** - Health panel data often violates classical error assumptions

4. **Consider sensitivity analyses** - Try alternative specifications to ensure health findings are robust

5. **Visualize your health data** - Plots of within and between variation can reveal important patterns in health disparities

6. **Be transparent about limitations** - All panel data approaches involve tradeoffs for health research

7. **Combine statistical tests with theory** - Tests like Hausman provide evidence, but theoretical considerations about health determinants are equally important

By understanding the conceptual foundations of different panel data models and their appropriate applications, health economists can leverage the rich information contained in county-level panel data to answer important health policy questions and address persistent health disparities.

Remember that panel data analysis in health economics isn't just about choosing the "best" model—it's about understanding the different types of variation in your health data and selecting the approach that best addresses your specific health policy research question.

### References

Baltagi, B. H. (2021). *Econometric Analysis of Panel Data* (6th ed.). Springer.

Wooldridge, J. M. (2010). *Econometric Analysis of Cross Section and Panel Data* (2nd ed.). MIT Press.

Currie, J., & Duque, V. (2019). Medicaid: What Does It Do, and Can We Do Better? *Annual Review of Economics, 11*, 171-190.

Chetty, R., Stepner, M., Abraham, S., Lin, S., Scuderi, B., Turner, N., Bergeron, A., & Cutler, D. (2016). The Association Between Income and Life Expectancy in the United States, 2001-2014. *JAMA, 315*(16), 1750-1766.

Case, A., & Deaton, A. (2020). *Deaths of Despair and the Future of Capitalism*. Princeton University Press.

Marmot, M. (2015). The Health Gap: The Challenge of an Unequal World. *The Lancet, 386*(10011), 2442-2444.

Croissant, Y., & Millo, G. (2008). Panel Data Econometrics in R: The plm Package. *Journal of Statistical Software, 27*(2), 1-43.